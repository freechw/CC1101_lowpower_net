# CC1101_lowpower_net
STM8+CC1101
# 2018.05.05
## V1.2
### 1.低功耗终端载波防碰撞与WOR相结合。
### 2.WOR设置为休眠周期300ms，唤醒窗口585us。
### 3.WOR唤醒窗口接受方式为检测同步字与前导码。大大提升接收成功率。
### 4.采用网关一直重复发，直到收到终端ACK停止发送的机制。
### 5.配合ACK，优化之前设计的协议，减少帧长，缩短发送时间。
# 2018.05.06
## V1.3
### 1.由于程序逻辑与机制越来越复杂，针对STM8找到了一个适用的轻量级RTOS:Atomthreads。
### 2.成功将Atomthreads移植到网关模块。
### 3.基于RTOS优化底层框架，将uart、timer、超时机制、RF驱动等程序线程化。
将各中断服务程序适配到RTOS。
高优先级任务采用sem机制阻塞，等待触发，特别涉及到GPIO、UART、Timer中断部分。<br>
uart串口在任务上实现透传功能，串口数据采用消息队列机制。<br>
# 2018.05.07
## V1.4
### 1.由于STM8L101只有8KbFlash,1KbRAM,程序在写到第5个任务线程时，编译代码空间溢出,是RAM不够用了。<br>
故放弃使用RTOS:atomthreads,继续使用RTOS前的裸机代码，并完善底层。<br>

# 2018.05.08
## V1.5
### 1.实现网关与网关之间的简单的通信流程机制。
网关与网关之间发送数据，接收到ACK后结束。<br>
具有载波防碰撞机制，ACK超时机制。<br>
### 2.优化无线收发数据缓冲区的结构体组织。
修复一个小BUG：收发缓冲区误配置为同一个存储区，导致接收数据后，部分帧头数据被发送的ACK覆盖掉，最后获得的接收的数据不正确。<br>

# 2018.05.09
## V1.6
### 1.重新设计载波防碰撞机制
载波防碰撞：在发送无线数据前，先对信道进行监听，若信号强度超过设定的RSSI阈值，则说明有信号，<br>
则暂不发送，待延时一段时间，再发送无线数据。<br>
载波防碰撞实现有三种机制：CS、CCA、直接RSSI比较。<br>
##### 载波监听 (CS):CC1101内部载波监听机制，可用于空闲信道评估。<br>
CS可由状态寄存器读取到，有两种触发方式：<br>
1.当 RSSI 大于可编程绝对阈值时 CS 有效，而 RSSI 小于该可编程绝对阈值（有滞后）时则 CS 无效。<br>
2.在 RSSI 采样值从一个到下一个采样值过程中 RSSI 增加可编程 dB 数时置位 CS；<br>
在 RSSI 降低至相同的 dB 数时则取消 CS。该设置不依赖于绝对信号电平，因此，在具有时变噪声底限的环境中对检测信号十分有用。<br>
##### 空闲信道评估 (CCA)：CC1101内部空闲信道评估机制。<br>
空闲信道评估(CCA)用于表明当前信道是空闲还是忙碌。<br>
CC1100E 处于 RX 状态下，当发出 STX 或 SFSTXON 指令选通脉冲时，只有满足空闲信道要求的情况下才会进入 TX 或 FSTXON 状态。<br>
否则，芯片就会保持 RX 状态不变。如果随后信道可用，那么在通过 SPI 发送一条新的指令选通脉冲以前该无线电设备都不会<br>
进入 TX 或 FSTXON 状态。这种特性被称为“TX-if-CCA”。<br>
##### 直接RSSI比较<br>
自定义一个RSSI阈值，在发送无线数据时，在设置到发送模式之前，先设置为接收模式，然后读取RSSI值，<br>
将RSSI与自定义的RSSI值相比，若实测RSSI值大于设定阈值，则暂不发送，待延时一段时间，再发送无线数据。<br>
##### 在以上三种方式中，在之前的网关设备上全部成功实现。而后采用了CCA方案。<br>
CCA方案在实现ACK的网关上可用，因为网关不考虑功耗，大部分时间都处于接受状态。<br>
在具有WOR的低功耗终端上出现问题，网关突发数据时，先从休眠状态切换为空闲状态，然后设置为接收状态，此时RSSI读取正常，<br>
信道无载波，RSSI值约为-87dBm,小于设定的CS阈值-60dBm,但此时CC1101内部CCA信号指示信道不空闲，导致无论如何，<br>
终端都认为信道忙，不发送无线数据。<br>
故弃用CCA方案，选择直接RSSI比较方案。直接RSSI方案成功实现网关、终端的防碰撞机制。<br>
在网关上，切换到接受状态后可无需延时直接读取RSSI，提升载波防碰撞响应速度。<br>
在终端上，由于需要一个稳定建立时间，切换到接收状态后要1ms的延时，才能读到正确的RSSI的值。<br>
载波防碰撞的超时时间设置为1s，短时延为10ms，即：<br>
在发送无线数据时，若信道忙，则延时10ms，再发送，以此循环，若1s内发送仍不成功，则超时，放弃发送。<br>
### 2.设计网关与终端通信机制<br>

|数据流程| | |
|---|---|---|
|网关|1.-->数据*|终端
|网关|2.<--ACK|终端
| | |
|网关|1.<--数据|终端
|网关|2.-->ACK*|终端
|网关|3.<--ACK|终端


说明：<br>
1.箭头方向表示发送数据方向。<br>
2.\*表示持续发送，直到接收到ACK为止。<br>
3.通信流程到网关收到ACK结束。<br>
4.持续发送的超时时间设置为2S。<br>
5.等待ACK超时时间为2S。<br>
网关向终端发送无线数据时，采用的机制是循环发送，直到接收到终端返回的ACK停止。<br>
循环发送的超时时间设置为2s,短延时为50ms，即：<br>
在网关向终端发送无线数据时，循环发送。一次发送完毕后，设置为接收模式，延时50ms，等待终端返回的ACK信号。<br>
若接收到ACK信号，则结束发送，若循环发送2s内没接收到ACK，则超时，放弃发送。<br>
终端为低功耗模式，使用WOR。WOR配置为EVENT0周期时间为300ms，在此周期中RX Time为584us,即终端每300ms唤醒一次，<br>
接收窗口期只有584us。测试时发现，由于窗口期太窄，发送无线数据的时间很难刚好对上窗口期，导致网关持续发送几乎到4、5秒，<br>
终端才收到一次数据。<br>
故修改设置，缩短唤醒周期时间为100ms，接收窗口期设置为1.58ms。修改了此设置后，实测网关持续发送2s时，终端总能稳定收到2次数据。<br>
### 3.实现了上述网关与终端的应答机制<br>

# 2018.05.10
## V1.7
### 1.更新无线组网与通信协议。<br>
将功能字与类型分拆开来，以解决：<br>
1.区分返回不同类型的ACK的问题。<br>
2.区分广播群发后的返回ACK地址问题。<br>
3优化通信结构。<br>
无线协议帧头<br>

****

|0|1|2|3|4|5…|
|---|---|---|---|---|---
|起始|本机地址|目标地址|功能字|类型|数据
|EB|local addr|target addr|01获取网关地址|01ACK|	      
| | | |02获取终端地址|02CMD|	    
| | | |03终端申请地址| |      
| | | |04返回申请地址| |       
| | | |05数据透传| |    


****

### 2.设计终端和网关的地址相关协议。<br>

|地址|类型|标记
|---|---|---|
|0x00            |     广播    |  TYPE_BROADCAST 
|0x01 ~ 0x0A     |    网关地址 |  TYPE_GATEWAY  
|0x0B ~ 0xFE     |    终端地址 |  TYPE_TERMINAL 


所有网关初始地址为0x01,网关自分配地址。<br>
所有终端初始地址为0x0B，终端需向网关申请地址。<br>
共255个地址。<br>
组网结构为星型结构，每个网关可支持244个终端地址，一个区域内最多10个网关。<br>
网关间可通信。<br>
终端之间不可通信。<br>
建立两个地址池：<br>
INT8U Device_addrpool[255]={0};//地址分配池<br>
INT8U Device_aliveadd[255]={0};//设备在线池<br>
其中地址分配池用于标记已分配的地址，<br>
为1则地址已占用，0则未占用。<br>
设备在线池用于标记在线的网关和终端设备。<br>
当接收到无线数据时，提取到帧中的发送端的地址后对地址进行标记，<br>
在地址分配池中，该地址对应的数置1，表示地址已占用，置1后不再清零。<br>
在设备在线池中，该地址对应的数++，最多加到3。<br>
当发送无线数据时，若发送成功，返回的ACK也对其地址进行了上述标记。<br>
若发送失败，则设备在线池中，该地址对应的数--，最低为0，则数值>0表示设备在线，数值为0表示设备不在线。<br>
### 3.设计地址分配程序<br>
#### 1.网关自分配地址流程：<br>
上电初始化时，先读取EEPROM里存的RF配置标记位，<br>
若为0则表示该设备未经初始化，需要进行RF网络初始化，<br>
若为1则表示该设备已初始化过，从EEPROM里读取配置数据，如本机地址等。<br>
网关RF网络初始化：<br>
1.广播发送寻找网关指令。<br>
2.等待2s,在这2秒中，若有其他网关收到该指令，则会返回ACK。<br>
3.利用返回的ACK对地址池进行标记。<br>
4.从前往后在地址分配池里从0X01 ~ 0X0A遍历，若有地址对应的值为0，说明未被占用，<br>
则跳出遍历，将该地址设置为本网关的地址，并对该地址进行标记。<br>
#### 2.设计终端选择最优网关流程<br>
利用设备在线池里的数据，在0x00~0x0A范围内，从前往后找最大值（最大为3），<br>
选择最大值为3是考虑到，若网关突然掉线，则只要最多3次连接失败就标记网关不在线，并切换网关。<br>
若一直加到255，则反应时间太慢，需要发送很多次，值才能递减到0。<br>
用返回的最大的值对应的地址设置为网关地址。<br>
这样，选择网关是依据最多次成功连接来的，而且支持动态选择网关。<br>
若返回为0，则说明设备在线池里没有可用网关，则终端广播发送寻找网关指令。<br>
### 4.修复读写EEPROM的BUG。<br>
STM8的FLASH与EEPROM共用8KB空间，EEPROM为2KB，之前从起始位置读取，发现已经覆盖程序区了，<br>
导致各种难以找原因的运行错误。现在优化为从空间最末位置开始，倒序往前读写EEPROM，程序运行恢复正常。<br>
### 5.完成寻找网关、网关初始化时自分配地址功能。<br>
测试环境：3个网关，两个初始化过的网关，地址为0x01与0x02，一个未初始化过的网关，初始地址为0x01。<br>
1.只运行0x01网关，网关初始化后地址自配置为0x02<br>
2.只运行0x02网关，网关初始化后地址自配置为0x01<br>
3.运行0x01和0x02网关，网关初始化后地址自配置为0x03<br>

# 2018.05.11
### 1.将网关修改与增加的部分功能代码适配到终端的代码中。
### 2.终端的工程增加寻找网关并选择最优网关的功能，机制有待测试。
### 3.设计网关的串口通信、终端的串口通信机制。
网关串口协议<br>

|0|1...
|---|---
|目标地址|数据
|target addr| |

网关串口接收到的数据要转发到终端上，故接收的数据必须要有一个确定的终端的地址来发送数据。<br>
网关在收到串口数据后，发送前需打包数据，先添加帧头，在帧头中放入本机地址、要发送的终端地址、功能字05（表示数据透传）、类型02CMD，<br>
在其后为接收到的串口数据（去除0目标地址）<br>
网关在收到无线数据时，若类型为02CMD，功能字为05（数据透传），则将除去帧头的数据发送到串口。<br>
<br>
终端串口协议<br>

|0...
|---
|数据

终端串口接收的数据无协议。<br>
终端收到串口数据后，发送前先选择最优网关，然后打包数据，添加帧头。<br>
终端在收到无线数据时，若类型为02CMD，功能字为05（数据透传），则将除去帧头的数据发送到串口。<br>
### 4.写了测试RSSI数据.xlsx文件，在/DOC中。
内容为几张配置表：<br>
1.与确定RSSI阈值有关的三张表typical RSSI value(dBm)、target value、absolute RSSI threshold。<br>
2.CS threshold 的RSSI阈值确定的公式。<br>
the RSSI value at CS threshold = typical RSSI value + (target value - 33) + (0 + absolute RSSI threshold)<br>
3.CS threshold 的RSSI阈值配置的示例与实际配置。<br>
4.将RSSI的寄存器值转换为实际值的表Typical RSSI_offset Values与过程。<br>
5.根据实际配置参数选择的RSSI_offset Value。<br>
6.根据实际配置参数在实际环境下测得的不同距离的RSSI寄存器值和实际RSSI值。表：Test RSSI value<br>
说明：RF实际配置参数记录在/DOC/配置参数.xlsx文件中。<br>
### 5.to do list:
1.测试终端寻找网关机制。<br>
2.测试终端选择最优网关机制。<br>
3.测试终端向网关申请地址机制。<br>
4.测试终端、网关的串口透传机制。<br>
