# CC1101_lowpower_net
STM8+CC1101
# 2018.05.10
## V1.7
### 1.更新无线组网与通信协议。<br>
将功能字与类型分拆开来，以解决：<br>
1.区分返回不同类型的ACK的问题。<br>
2.区分广播群发后的返回ACK地址问题。<br>
3优化通信结构。<br>
无线协议帧头<br>		
| 0   |	     1	     |     2	         |          3	         |       4	  |      5…  |   <br>
|起始 |	 本机地址	|    目标地址        |	    功能字	      |	      类型      |    数据  |  <br>
|EB   |	 local addr  |	  target addr    |	  01获取网关地址  |	   01ACK     |	        |    <br>
|    |               |	                 |        02获取终端地址  |	   02CMD     |	         |   <br>
|    |		     |	                 |        03终端申请地址  |		     |           |    <br>
|    |		     |	                 |        04返回申请地址  |		     |           |    <br>
|    |		     |	                 |        05数据透传      |		       |          |      <br>

### 2.设计终端和网关的地址相关协议。<br>
|地址：0x00            |     广播    |  TYPE_BROADCAST| <br>
|地址：0x01 ~ 0x0A     |    网关地址 |  TYPE_GATEWAY  | <br>
|地址：0x0B ~ 0xFE     |    终端地址 |  TYPE_TERMINAL  |<br>
所有网关初始地址为0x01,网关自分配地址。<br>
所有终端初始地址为0x0B，终端需向网关申请地址。<br>
共255个地址。<br>
组网结构为星型结构，每个网关可支持244个终端地址，一个区域内最多10个网关。<br>
网关间可通信。<br>
终端之间不可通信。<br>
建立两个地址池：<br>
INT8U Device_addrpool[255]={0};//地址分配池<br>
INT8U Device_aliveadd[255]={0};//设备在线池<br>
其中地址分配池用于标记已分配的地址，<br>
为1则地址已占用，0则未占用。<br>
设备在线池用于标记在线的网关和终端设备。<br>
当接收到无线数据时，提取到帧中的发送端的地址后对地址进行标记，<br>
在地址分配池中，该地址对应的数置1，表示地址已占用，置1后不再清零。<br>
在设备在线池中，该地址对应的数++，最多加到3。<br>
当发送无线数据时，若发送成功，返回的ACK也对其地址进行了上述标记。<br>
若发送失败，则设备在线池中，该地址对应的数--，最低为0，则数值>0表示设备在线，数值为0表示设备不在线。<br>
### 3.设计地址分配程序<br>
#### 1.网关自分配地址流程：<br>
上电初始化时，先读取EEPROM里存的RF配置标记位，<br>
若为0则表示该设备未经初始化，需要进行RF网络初始化，<br>
若为1则表示该设备已初始化过，从EEPROM里读取配置数据，如本机地址等。<br>
网关RF网络初始化：<br>
1.广播发送寻找网关指令。<br>
2.等待2s,在这2秒中，若有其他网关收到该指令，则会返回ACK。<br>
3.利用返回的ACK对地址池进行标记。<br>
4.从前往后在地址分配池里从0X01 ~ 0X0A遍历，若有地址对应的值为0，说明未被占用，<br>
则跳出遍历，将该地址设置为本网关的地址，并对该地址进行标记。<br>
#### 2.设计终端选择最优网关流程<br>
利用设备在线池里的数据，在0x00~0x0A范围内，从前往后找最大值（最大为3），<br>
选择最大值为3是考虑到，若网关突然掉线，则只要最多3次连接失败就标记网关不在线，并切换网关。<br>
若一直加到255，则反应时间太慢，需要发送很多次，值才能递减到0。<br>
用返回的最大的值对应的地址设置为网关地址。<br>
这样，选择网关是依据最多次成功连接来的，而且支持动态选择网关。<br>
若返回为0，则说明设备在线池里没有可用网关，则终端广播发送寻找网关指令。<br>
### 4.修复读写EEPROM的BUG。<br>
STM8的FLASH与EEPROM共用8KB空间，EEPROM为2KB，之前从起始位置读取，发现已经覆盖程序区了，<br>
导致各种难以找原因的运行错误。现在优化为从空间最末位置开始，倒序往前读写EEPROM，程序运行恢复正常。<br>
### 5.完成寻找网关、网关初始化时自分配地址功能。<br>
测试环境：3个网关，两个初始化过的网关，地址为0x01与0x02，一个未初始化过的网关，初始地址为0x01。<br>
1.只运行0x01网关，网关初始化后地址自配置为0x02<br>
2.只运行0x02网关，网关初始化后地址自配置为0x01<br>
3.运行0x01和0x02网关，网关初始化后地址自配置为0x03<br>
